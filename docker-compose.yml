# ============================================================
# Email Engine — Docker Compose
# Development & Production Orchestration
#
# Usage:
#   Start all services:  docker-compose up --build
#   Stop all services:   docker-compose down
#   View logs:           docker-compose logs -f [service]
#
# Services:
#   api      → FastAPI backend   → http://localhost:8000
#   worker   → Email worker      → (background process)
#   client   → Next.js frontend  → http://localhost:3000
#   nginx    → Reverse proxy     → http://localhost:80 (production)
# ============================================================

version: "3.9"

services:

  # ── Backend API ─────────────────────────────────────────
  api:
    build:
      context: .
      dockerfile: deploy/api/Dockerfile
    container_name: email_engine_api
    restart: unless-stopped
    ports:
      - "8000:8000"
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - CLERK_SECRET_KEY=${CLERK_SECRET_KEY}
      - CLERK_PUBLISHABLE_KEY=${CLERK_PUBLISHABLE_KEY}
    env_file:
      - .env
    volumes:
      - ./platform/api/assets:/app/assets # Persist uploaded files
    healthcheck:
      test: [ "CMD", "curl", "-f", "http://localhost:8000/health" ]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - email_engine_net

  # ── Background Worker ────────────────────────────────────
  worker:
    build:
      context: .
      dockerfile: deploy/worker/Dockerfile
    container_name: email_engine_worker
    restart: unless-stopped
    env_file:
      - .env
    environment:
      - SUPABASE_URL=${SUPABASE_URL}
      - SUPABASE_SERVICE_ROLE_KEY=${SUPABASE_SERVICE_ROLE_KEY}
      - SMTP_HOST=${SMTP_HOST}
      - SMTP_PORT=${SMTP_PORT}
      - SMTP_USER=${SMTP_USER}
      - SMTP_PASS=${SMTP_PASS}
    depends_on:
      api:
        condition: service_healthy
    networks:
      - email_engine_net

  # ── Frontend ─────────────────────────────────────────────
  client:
    build:
      context: .
      dockerfile: deploy/client/Dockerfile
    container_name: email_engine_client
    restart: unless-stopped
    ports:
      - "3000:3000"
    environment:
      - NEXT_PUBLIC_API_URL=http://api:8000
      - NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=${NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY}
    env_file:
      - .env
    depends_on:
      - api
    networks:
      - email_engine_net
  # ── Nginx Reverse Proxy ──────────────────────────────────
  # Uncomment in production to route everything through port 80
  # nginx:
  #   image: nginx:alpine
  #   container_name: email_engine_nginx
  #   restart: unless-stopped
  #   ports:
  #     - "80:80"
  #   volumes:
  #     - ./deploy/nginx/nginx.conf:/etc/nginx/conf.d/default.conf:ro
  #   depends_on:
  #     - api
  #     - client
  #   networks:
  #     - email_engine_net

  # ── Shared Network ─────────────────────────────────────────
networks:
  email_engine_net:
    driver: bridge

# ── Future: Add Redis for scaling ──────────────────────────
# To enable Redis (Phase 7 Upgrade), add:
#
#   redis:
#     image: redis:7-alpine
#     container_name: email_engine_redis
#     restart: unless-stopped
#     ports:
#       - "6379:6379"
#     networks:
#       - email_engine_net
